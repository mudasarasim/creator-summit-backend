<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <title>Speaker Profile</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="css/bootstrap.min.css">
  <!-- ✅ Full FontAwesome CDN -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"
    integrity="sha512-..." crossorigin="anonymous" referrerpolicy="no-referrer" />
  <!-- JS RENDERING SPEAKERS -->
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      Promise.all([
        fetch('/api/speakers').then(res => res.json()),
        fetch('/api/vote-results').then(res => res.json())
      ])
        .then(([speakers, voteResults]) => {
          const container = document.getElementById('speakers-container');
          const urlParams = new URLSearchParams(window.location.search);
          const voteName = urlParams.get('vote');

          // 🧠 Show only the speaker matching the vote name
          const selectedSpeaker = speakers.find(s => s.name.toLowerCase() === voteName?.toLowerCase());
          if (!selectedSpeaker) {
            container.innerHTML = `<p class="text-danger">Speaker not found.</p>`;
            return;
          }

          // Convert voteResults to object for quick lookup
          const voteMap = {};
          voteResults.forEach(v => {
            voteMap[v.speaker] = v.total_votes;
          });

          const imageUrl = selectedSpeaker.youtube_image && selectedSpeaker.youtube_image.startsWith('/uploads/')
            ? selectedSpeaker.youtube_image
            : selectedSpeaker.youtube_image
              ? `/uploads/${selectedSpeaker.youtube_image}`
              : 'img/speaker_1.png';

          const votes = voteMap[selectedSpeaker.name] || 0;

          const html = `
  <div class="col-lg-3 col-md-6 mb-4 mx-auto">
    <div class="card text-center border-0 shadow-sm">
      <div class="mb-3">
        <img 
          src="${imageUrl}" 
          alt="${selectedSpeaker.name}" 
          onclick="openSpeakerModal('${selectedSpeaker.name}', '${selectedSpeaker.role || ''}', '${selectedSpeaker.description || ''}', '${imageUrl}')" 
          style="width: 100%; height: 250px; object-fit: cover; margin-top: -20px; border-radius: 20px 20px 0px 0px"
        />
      </div>
      <h5 style="font-weight: 700; color: #002b7f;">${selectedSpeaker.name}</h5>
      <p style="color: #777; margin-top: 5px;">${selectedSpeaker.niche || 'Speaker'}</p>
      <button class="btn btn-outline-info btn-sm mt-1" onclick="openVoteModal('${selectedSpeaker.name}')">Vote Now</button>
      <p style="margin-top: 5px; font-weight: bold; color: green;">Votes: ${votes}</p>
      <div class="d-flex justify-content-center mt-3">
        ${selectedSpeaker.instagram ? `<a href="${selectedSpeaker.instagram}" target="_blank" class="mx-1"><i class="fab fa-instagram"></i></a>` : ''}
        ${selectedSpeaker.youtube ? `<a href="${selectedSpeaker.youtube}" target="_blank" class="mx-1"><i class="fab fa-youtube"></i></a>` : ''}
        ${selectedSpeaker.tiktok ? `<a href="${selectedSpeaker.tiktok}" target="_blank" class="mx-1"><i class="fab fa-tiktok"></i></a>` : ''}
      </div>
    </div>
  </div>
    `;

          container.innerHTML = html;

          // ✅ Auto-open vote modal if query param exists
          if (voteName) {
            setTimeout(() => {
              openVoteModal(voteName);
            }, 300);
          }
        });

      // Hide modals initially
      document.getElementById('voteModal').style.display = 'none';
      document.getElementById('successModal').style.display = 'none';
    });

  </script>
  <style>
    body {
      background-color: #f8f9fa;
    }

    .profile-container {
      max-width: 600px;
      margin: auto;
      background: #fff;
      padding: 40px 30px;
      border-radius: 16px;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.05);
      animation: fadeIn 0.6s ease-in-out;
    }

    @keyframes fadeIn {
      0% {
        opacity: 0;
        transform: translateY(20px);
      }

      100% {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .profile-img {
      width: 180px;
      height: 180px;
      object-fit: cover;
      border-radius: 50%;
      background: #eee;
      margin: 0 auto 20px auto;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
    }

    .profile-name {
      color: #002b7f;
      font-weight: 700;
      font-size: 26px;
    }

    .profile-role {
      color: #888;
      font-size: 16px;
      margin-bottom: 10px;
    }

    .profile-description {
      color: #333;
      font-size: 15px;
      margin-top: 15px;
    }

    .social-icons {
      margin-top: 25px;
    }

    .social-icons a {
      font-size: 22px;
      margin: 0 10px;
      color: #555;
      transition: color 0.3s;
    }

    .social-icons a:hover {
      color: #007bff;
    }

    .btn-share {
      margin: 10px 5px 0;
      font-size: 14px;
      padding: 8px 16px;
      border-radius: 20px;
    }

    .vote-btn {
      margin-top: 30px;
      font-weight: 600;
      border-radius: 30px;
      padding: 10px 25px;
    }

    /* ✅ Toast styling */
    #copy-toast {
      position: fixed;
      bottom: 30px;
      left: 50%;
      transform: translateX(-50%);
      background-color: #28a745;
      color: #fff;
      padding: 12px 20px;
      border-radius: 30px;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
      font-size: 14px;
      display: none;
      z-index: 9999;
      animation: fadeToast 2s ease-in-out;
    }

    @keyframes fadeToast {
      0% {
        opacity: 0;
        transform: translateY(20px);
      }

      10% {
        opacity: 1;
        transform: translateY(0);
      }

      90% {
        opacity: 1;
        transform: translateY(0);
      }

      100% {
        opacity: 0;
        transform: translateY(20px);
      }
    }
  </style>
</head>

<body>
  <div class="container py-5">
    <a href="speakers.html" class="btn btn-outline-secondary mb-4">
      <i class="fas fa-arrow-left"></i> Back to All Angels
    </a>

    <div id="speaker-detail" class="profile-container text-center">
      <!-- Speaker details will be rendered here -->
    </div>
  </div>

  <!-- ✅ Toast element -->
  <div id="copy-toast">📋 Link copied successfully!</div>

  <!-- Vote Modal -->
  <div id="voteModal"
    style="display:none; position:fixed; top:0; left:0; right:0; bottom:0; background:rgba(0,0,0,0.5); z-index:9999; display:flex; align-items:center; justify-content:center;">
    <form id="voteForm" class="card p-4" style="width: 100%; max-width: 400px;" onsubmit="submitVote(event)">
      <h5 class="mb-3 text-center">Vote for <span id="voteSpeakerName"></span></h5>

      <input type="text" name="name" class="form-control mb-2" id="voterName" placeholder="Your Name" required />
      <input type="email" name="email" class="form-control mb-2" id="voterEmail" placeholder="Your Email" required />
      <input type="tel" name="phone" class="form-control mb-3" id="voterPhone" placeholder="Your Phone" required />

      <!-- Hidden speaker input -->
      <input type="hidden" name="speaker" id="voterSpeaker" />

      <div class="d-flex justify-content-between">
        <button type="button" class="btn btn-secondary" onclick="closeVoteModal()">Cancel</button>
        <button type="submit" class="btn btn-primary">Vote Now</button>
      </div>
    </form>
  </div>

  <!-- Success Modal -->
  <div id="successModal"
    style="display:none; position:fixed; top:0; left:0; right:0; bottom:0; background:rgba(0,0,0,0.5); z-index:9999; display:flex; align-items:center; justify-content:center;">
    <div class="card text-center p-4" style="max-width: 300px;">
      <h5 id="successMessage" class="mb-3 text-success">Vote Submitted! Thanks For Voting</h5>
      <button class="btn btn-sm btn-success" onclick="closeSuccessModal()">OK</button>
    </div>
  </div>


  <script>
    const urlParams = new URLSearchParams(window.location.search);
    const speakerName = urlParams.get('speaker');

    if (speakerName) {
      fetch(`/api/speakers/${encodeURIComponent(speakerName)}`)
        .then(res => res.json())
        .then(speaker => {
          const imageUrl = speaker.youtube_image && speaker.youtube_image.startsWith('/uploads/')
            ? speaker.youtube_image
            : speaker.youtube_image
              ? `/uploads/${speaker.youtube_image}`
              : 'img/speaker_1.png';

          const shareLink = `${window.location.origin}${window.location.pathname}?speaker=${encodeURIComponent(speaker.name)}`;

          const html = `
            <img src="${imageUrl}" alt="${speaker.name}" class="profile-img">
            <h2 class="profile-name">${speaker.name}</h2>
            <h5 class="profile-role">${speaker.role || ''}</h5>
            <p class="profile-description">${speaker.description || 'No description provided.'}</p>
            
            <div class="social-icons">
              ${speaker.instagram ? `<a href="${speaker.instagram}" target="_blank"><i class="fab fa-instagram"></i></a>` : ''}
              ${speaker.youtube ? `<a href="${speaker.youtube}" target="_blank"><i class="fab fa-youtube"></i></a>` : ''}
              ${speaker.tiktok ? `<a href="${speaker.tiktok}" target="_blank"><i class="fab fa-tiktok"></i></a>` : ''}
            </div>

            <div class="mt-3">
              <button class="btn btn-outline-primary btn-share" onclick="copyLink('${shareLink}')">
                <i class="fas fa-copy"></i> Copy Profile Link
              </button>
              <button class="btn btn-outline-success btn-share" onclick="shareLinkNow('${shareLink}')">
                <i class="fas fa-share"></i> Share
              </button>
            </div>

            <button class="btn btn-primary vote-btn" onclick="openVoteModal('${speaker.name}')">
  Vote for ${speaker.name}
</button>

          `;

          document.getElementById('speaker-detail').innerHTML = html;
        })
        .catch(err => {
          document.getElementById('speaker-detail').innerHTML = "<p class='text-danger'>Speaker not found.</p>";
        });
    } else {
      document.getElementById('speaker-detail').innerHTML = "<p class='text-muted'>No speaker selected.</p>";
    }

    // ✅ Copy profile link with toast
    function copyLink(link) {
      navigator.clipboard.writeText(link).then(() => {
        const toast = document.getElementById("copy-toast");
        toast.style.display = "block";
        toast.classList.remove("showing");
        void toast.offsetWidth; // force reflow
        toast.classList.add("showing");
        setTimeout(() => {
          toast.style.display = "none";
        }, 2000);
      });
    }

    // ✅ Use Web Share API
    function shareLinkNow(link) {
      if (navigator.share) {
        navigator.share({
          title: "Check out this speaker!",
          url: link
        }).catch(console.error);
      } else {
        alert("Sharing not supported. You can copy the link instead.");
      }
    }
  </script>

  <script>
    function openVoteModal(speakerName) {
      document.getElementById('voteSpeakerName').innerText = speakerName;
      document.getElementById('voterSpeaker').value = speakerName;
      document.getElementById('voteModal').style.display = 'flex';
    }

    function closeVoteModal() {
      document.getElementById('voteModal').style.display = 'none';
      document.getElementById('voteSpeakerName').innerText = '';
      document.getElementById('voterName').value = '';
      document.getElementById('voterEmail').value = '';
      document.getElementById('voterPhone').value = '';
      document.getElementById('voterSpeaker').value = '';
    }

    function closeSuccessModal() {
      document.getElementById('successModal').style.display = 'none';
    }

    function submitVote(event) {
      event.preventDefault();

      const name = document.getElementById("voterName").value.trim();
      const email = document.getElementById("voterEmail").value.trim();
      const phone = document.getElementById("voterPhone").value.trim();
      const speaker = document.getElementById("voterSpeaker").value.trim();

      fetch('/api/vote', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ name, email, phone, speaker })
      })
        .then(res => res.json())
        .then(data => {
          const modal = document.getElementById("successModal");
          const message = document.getElementById("successMessage");

          if (data.message === "Vote submitted successfully!") {
            message.innerText = "✅ Vote Submitted! Thanks For Voting";
            message.classList.add("text-success");
            message.classList.remove("text-danger");
          } else {
            message.innerText = "⚠️ " + data.message;
            message.classList.add("text-danger");
            message.classList.remove("text-success");
          }

          closeVoteModal();
          modal.style.display = "flex";
        })
        .catch(err => {
          console.error("Error:", err);
        });
    }
  </script>

</body>

</html>